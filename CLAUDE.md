# 人口ピラミッド可視化アプリケーション - プロジェクト概要

## 現在の状況
このプロジェクトは人口ピラミッド可視化アプリケーションで、以下の機能が完成しています：

### 完成済み機能
1. **都道府県別人口ピラミッド表示**
   - 全国・都道府県別の人口データ表示
   - 2025年〜2050年の将来推計データ対応
   - 動的スケール計算による最適な表示

2. **データ処理の改善**
   - 全国データと都道府県データの単位統一問題を解決
   - 全国データ：実人数 → 千人単位グラフ表示
   - 都道府県データ：千人単位 → そのまま表示

3. **年度比較機能（最新改善版）**
   - **初期設定**: 2025年と2035年で比較
   - **重ね描画**: 同一グラフに2年度のデータを重ねて表示
   - **視覚的差別化**: 
     - 2025年: 塗りつぶしバー (opacity 0.7)
     - 2035年: 濃い色の細い点線囲みバー (stroke-width: 1, stroke-dasharray: '3,3')
   - **左右一杯表示**: グラフ幅をコンテナ幅一杯に設定
   - **凡例**: 下部中央に男性・女性別に年度を区別して表示

### 技術的詳細
- **フレームワーク**: React 19 + TypeScript
- **可視化**: D3.js
- **データソース**: e-Stat API + ローカルJSONファイル
- **プロセス管理**: PM2

### データ処理の重要なポイント
- **全国データ**: prefectureCode='00000'で識別、実人数データを千人単位に変換してグラフ表示
- **都道府県データ**: 千人単位データをそのまま使用

## 実装済み機能（2024年12月更新）

### ダウンロード機能（2024年12月新規追加）
Excel（数字）とPDF（グラフ）のダウンロード機能が実装されました：

#### 実装済み内容
1. **Excel（数字）ダウンロード**
   - 人口ピラミッドの数値データをExcel形式でダウンロード
   - **フォーマット**:
     - 1行目: **全都道府県名**と年度情報（複数地域時も全て列挙）
     - 2行目: 単位表示「単位：千人」
     - 3行目: 空行
     - 4行目以降: データ（ヘッダー行 + 年齢層別データ + 合計行）
   - **スタイル設定**: ヘッダー太字、背景色、列幅自動調整
   - 年齢層別の男性・女性・合計人口データ
   - 組合員数データ（有効時のみ）
   - 年度比較データ（変化率含む）
   - ファイル名: `人口データ_[地域名]_[年度].xlsx` / `人口比較データ_[地域名]_[年度1]vs[年度2].xlsx`

2. **PDF（グラフ）ダウンロード**
   - 人口ピラミッドのグラフをPDF形式でダウンロード
   - SVGからの高品質な画像変換
   - A4横向きレイアウト
   - **長いタイトル対応**: 自動改行・省略・フォントサイズ調整
   - **レイアウト最適化**: 固定幅コンテナでグラフ欠けを防止
   - タイトルと年度情報を含む
   - ファイル名: `人口ピラミッド_[地域名]_[年度].pdf`

3. **使用ライブラリ**
   - **xlsx**: Excelファイル生成
   - **jsPDF**: PDF生成
   - **html2canvas**: SVGからCanvasへの変換
   - **file-saver**: ブラウザでのファイル保存

4. **UI配置**
   - 各コンポーネントの右上にダウンロードボタンを配置
   - 緑色のExcelボタンと赤色のPDFボタン
   - アイコン付きで視覚的に分かりやすい

5. **複数地域対応（完全対応版）**
   - **地域名表示の改善**: 複数地域選択時に具体的な都道府県名を表示
   - **UI表示**: 3地域以下は全て列挙、それ以上は省略形（例：「北海道・青森県他3県」）
   - **Excel 1行目**: **全都道府県名を完全表示**（例：「北海道・青森県・岩手県・宮城県・秋田県・山形県・福島县・茨城県・栃木県・群馬県・埼玉県・千葉県・東京都・神奈川県・新潟県」）
   - **シート名・タイトル**: 省略形を使用（例：「15地域_2025年」）
   - **ファイル名**: 安全な文字のみ使用（例：「北海道_青森_他13地域」）
   - **31文字制限**: Excel制限に対応した自動短縮機能

### 組合員数推計機能
20-44歳の若年層シェア率維持方針による組合員数推計機能が実装されました：

#### 実装済み内容
1. **UI機能**
   - ヘッダーに「組合員数推計」ボタンを実装
   - オン/オフ切り替え機能
   - 年度比較モードでも組合員データ表示対応

2. **データ構造**
   ```typescript
   export interface CoopMemberData {
     year: number;
     prefecture: string;
     prefectureCode: string;
     ageGroup: string;
     memberCount: number; // 組合員数（千人単位）
   }
   ```

3. **表示方法**
   - 人口ピラミッドの中央にオレンジ色のバーでオーバーレイ表示
   - 組合員の年齢別分布を人口データと同じスケールで表示
   - 専用ツールチップで詳細データ表示（人口データとは分離）
   - 年度比較モードでの組合員データ重ね表示

4. **データファイル構造**
   ```
   public/data/coop-members/
   ├── coop_members_01_2025.json    // 北海道2025年
   ├── coop_members_01_2030.json    // 北海道2030年
   ...
   ├── coop_members_47_2050.json    // 沖縄県2050年
   ├── coop_members_national_2025.json // 全国2025年
   └── coop_members_national_2050.json // 全国2050年
   ```

5. **サービスクラス**
   - `CoopMemberService`: 組合員データの読み込み・キャッシュ管理（実装済み）
   - 都道府県別・複数年度・複数地域対応
   - 全国データと都道府県データの統合処理

6. **推計ロジック（2024年12月更新）**
   - **若年層シェア率維持**: 20-44歳（従来は20-34歳から拡大）
   - **コーホート繰り上がり**: 45歳以上は年齢進行による推計
   - **生存率適用**: 70歳以上は死亡率を考慮した推計
   - **データ期間**: 2025年（基準年）〜2050年の5年刻み推計

#### 推計方法の詳細
- **20-44歳**: 2025年のシェア率を将来にわたって維持（新規加入促進策想定）
- **45歳以上**: コーホート繰り上がり + 人口変動率 + 生存率適用
- **基準データ**: 生協データ総覧の全国年齢構成比を都道府県別に按分

## ファイル構成
```
src/
├── components/
│   ├── PopulationPyramid.tsx          # メイン人口ピラミッド表示
│   ├── YearComparisonDemo.tsx         # 年度比較（重ね描画）
│   ├── PopulationStats.tsx            # 人口統計表示
│   └── PrefectureSelector.tsx         # 都道府県選択UI
├── services/
│   └── localDataService.ts            # データ処理・スケール計算
├── types/
│   └── population.ts                  # 型定義
└── hooks/
    ├── usePrefectureData.ts           # 単一都道府県データ管理
    └── useMultiplePrefectureData.ts   # 複数都道府県データ管理
```

## 最新のコミット状況（2024年12月更新）
現在のバージョンでは以下の機能が完全に実装されています：
- 年度比較機能（2つの年度のデータを重ねて表示）
- 組合員数推計機能（20-44歳シェア率維持方針による2025-2050年推計）
- 複数地域選択対応（人口データ・組合員データ共に合算表示）
- インタラクティブなツールチップ（人口・組合員データ分離表示）

## 推計結果サマリー（20-44歳シェア率維持方針）

### 全国組合員数推移
- **2025年**: 20,471千人（基準年）
- **2030年**: 19,395千人（-5.3%）
- **2035年**: 18,257千人（-10.8%）
- **2040年**: 16,629千人（-18.8%）
- **2045年**: 15,025千人（-26.6%）
- **2050年**: 13,461千人（-34.2%）

### 推計方針の効果
20-44歳のシェア率維持により、従来の20-34歳維持方針と比較して：
- より多くの年齢層で新規加入を促進
- 中年層（35-44歳）の組合員確保により組織基盤を強化
- 長期的な組合員数減少の抑制効果を期待

## 組合員推計ロジック（2024年12月更新）

### 年齢層別推計方式
- **20-44歳**: 100% シェア率維持（若年層の新規加入促進）
- **45-49歳**: コーホート70% + シェア率30%（移行期）
- **50-59歳**: コーホート80% + シェア率20%（安定期）
- **60歳以上**: コーホート90% + シェア率10%（高齢期）

詳細は `docs/coop_member_projection_logic.md` を参照。

### 人口変動率データ
都道府県×年齢区分×年度別の人口変動率を事前計算済み：
- 保存先: `public/data/population_change_rates/`
- 全体データ: `population_change_rates_all.json`
- 都道府県別: `change_rates_[都道府県コード].json`